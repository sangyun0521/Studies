동기화는 비용이 많이 든다
* 분산 환경에서 동기화는 모든 참가자와 통신을 해야하기 때문
* 특히 지리적으로 분산되어 있는 환경에서는 오버헤드가 더 클 수 밖에 없음
동기화 오버헤드를 줄이기 위해서는 의사결정에 필요한 메시지를 줄일 필요가 있다
그렇게 하기 위해서 일부 알고리즘은 리더 프로세스를 둔다

분산 시스템에서 어떤 프로세스든 리더 프로세스가 될 수 있으며 영구적이지 않다
* 기존 리더 프로세스에 장애가 발생하는 경우 새로운 리더를 선출해야 한다
* 리더는 항상 존재해야 하고 장애가 발생하는 경우 빠르게 리더를 선출해야 한다
* 이상적으로는 안정성을 보장해야한다 (하나의 리더만 존재)

하지만 실제로 많은 알고리즘들이 하나의 리더만 존재하도록 하는 것을 실패한다 (split brain)

분산 시스템에 안정적인 리더가 있으면 원격 노드의 상태를 동기화하지 않아도 되며 메시지를 줄일 수 있다
그러나 리더 프로세스가 병목이 될 수 있다는 단점이 있다
이런 문제를 해결하기 위해 많은 시스템이 데이터를 파티션으로 나누고 각 파티션 별로 리더를 선출한다 

### 불리 알고리즘
불리 알고리즘은 프로세스의 순위를 기반으로 리더를 선출하는 알고리즘이다

선출 작업
1. 각 프로세스는 자신보다 높은 순위의 프로세스에 선출 메시지를 보낸다 
2. 상위 순위 프로세스가 응답할 때 까지 대기한다
	* 상위 순위 프로세스가 응답하면 자신이 알고 있는 최상위 프로세스에 다음 단계 진행을 요청한다
3. 응답이 없으면 프로세스는 자신보다 더 높은 순위의 프로세스가 없다고 가정하고 하위 프로세스에 새로운 리더가 선출된 사실을 알린다

ex)
1~6번까지 프로세스가 존재하고 6번이 가장 우선 순위가 높다
6번에 장애가 발생한 것을 3번이 인지했다면 
* 3번은 4,5번에게 선출 메시지를 보낸다
* 4,5번은 모두 살아있음으로 응답을 보낸다
* 3번은 5번이 우선순위가 높으므로 5번에게 다음 단계 진행을 요청한다
* 5번이 새로운 리더가 되었으므로 리더가 선출된 사실을 나머지 노드에게 알린다

불리 알고리즘은 앞서 언급한 split brain 현상이 발생하기 쉽다
네트워크 파티션이 발생한 상황에서 서로 다른 두 그룹으로 분리되는 경우 2개 이상의 리더가 존재하게 된다 
또 다른 문제는 상위 순위 노드에게 우선권을 부여하기 때문에 상위 순위 노드가 불안정한 경우 선출 작업이 무한히 반복될 수 있다

### 다음 서열로 리더 역할 승계
불리 알고리즘은 split brain을 방지하기 위한 다양한 버전의 개선된 불리 알고리즘이 존재한다
그 중 하나는 리더 프로세스가 승계할 목록을 제공하는 것이다

* 리더 프로세스에 장애가 발생
* 리더가 미리 제공 해놓은 목록에서 가장 순위가 높은 프로세스에 메시지를 보냄
* 해당 프로세스가 응답을 하고 바로 자신이 새로운 리더가 되어 나머지 노드에게 알림

결과적으로 단순 불리 알고리즘과 비교했을 때 새로운 리더를 선출하는 과정에 필요한 단계가 줄어들었다

### 후보/일반 노드 최적화
이 방식은 리더가 될 수 있는 후보 그룹과 일반 그룹으로 노드를 나누는 방식이다

* 일반 프로세스는 모든 후보 노드에 메시지를 전송해 선출 작업을 시작한다
* 응답한 가장 높은 순위의 노드를 리더로 선출한다
* 이 때 각 노드별로 딜레이 시간을 지정해둔다
* 이 딜레이 시간은 높은 순위를 가지는 노드일 수록 작고 노드간 차이가 메시지가 노드간 왕복 이동 시간 보다 크기 때문에 이 차이를 이용하여 동시에 여러 선출 작업이 발생하는 것을 방지한다
* 새로운 리더는 자신이 리더임을 브로드캐스트 한다

### 초대 알고리즘
이 알고리즘은 그룹 별로 리더를 선출하기 때문에 동시에 여러 리더가 존재할 수 있다

* 각 프로세스는 자신이 유일한 구성원인 그룹의 리더로 시작
* 그룹 리더는 그룹에 속하지 않는 다른 프로세스를 자신의 그룹으로 초대 
* 초대를 받은 프로세스가 리더라면 두 그룹을 병합한다
그룹 병합시 필요한 메시지 수를 줄이려면 큰 그룹의 리더가 병합된 그룹의 리더가 되어야 한다

### 링 알고리즘
마치 토큰 링 프로토콜과 유사한 알고리즘이다

* 모든 노드는 링 형태로 연결돼 있고 각 노드는 토폴로지에 대한 정보를 알고있다
* 리더 프로세스에 장애를 감지한 프로세스는 선출 시작 메시지를 전달한다
* 각 프로세스는 전달 받은 메시지를 다음 프로세스에 전달한다
* 메시지에는 자신의 정보를 포함하여 전달한다
* 메시지는 전체 노드를 순회하여 시작한 노드로 다시 돌아오면 메시지에 포함된 노드 정보를 보고 가장 순위가 높은 노드를 리더로 선출한다
메모리를 아끼기 위해 노드 목록을 유지하지 않고 Max 노드만 유지할 수 도 있다
이 알고리즘 역시 네트워크 분할로 인해 split brain이 발생할 수 있다

### 결론
* 분산 시스템에서 의사 결정은 네트워크 비용이 많이 발생한다
* 따라서 리더를 선출하여 의사 결정을 하도록하면 비용을 줄일 수 있다
* 선출 비용은 장애시 발생하는 것이기 때문에 크지 않다
* 단일 프로세스의 병목은 파티션 그룹별 리더로 해결할 수 있다
* 리더 선출은 split brain에 유의해야한다
	* split brain은 과반수 합의 알고리즘에 의해 해결가능 하다
	* 이는 paxos, raft와 같은 합의 알고리즘이 필요하다
	* 리더 선출은 리더에 대해 합의하는 것이기 때문에 결국 합의 알고리즘이다